#SPDX-License-Identifier: MIT-0
---
# tasks file for homeserver
- name: Install sudo
  raw: yum install sudo -y
  changed_when: false

- name: Install python
  raw: yum install python python3-libdnf5 -y
  changed_when: false

- name: Make sure we have wheel user
  ansible.builtin.group:
    name: wheel
    state: present

- name: Allow 'wheel' group to have passwordless sudo
  ansible.builtin.lineinfile:
    dest: /etc/sudoers
    state: present
    regexp: '^wheel'
    line: '%wheel ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'

- name: Create homeserver user
  ansible.builtin.user:
    name: homeserver
    create_home: yes
    groups: wheel
    append: yes
    state: present

- name: Disable swap
  ansible.builtin.command: swapoff -a
  changed_when: false


- name: Disable swap in fstab
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
    replace: '# \1'
    backup: yes

- name: Install curl
  ansible.builtin.yum:
    name: curl
    state: present

- name: Install openssl
  ansible.builtin.yum:
    name: openssl
    state: present

- name: Download Helm Installation Script
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    dest: /tmp/get_helm.sh
    mode: '755'

- name: Run Helm Install
  ansible.builtin.command: /tmp/get_helm.sh
  args:
    creates: /usr/local/bin/helm
  register: helm_install_result
  changed_when: false

- name: Add /usr/local/bin to PATH
  ansible.builtin.lineinfile:
    path: ~/.bashrc
    line: 'export PATH=$PATH:/usr/local/bin'
  when: helm_install_result.rc == 0

- name: Check if helm is installed
  shell: helm version
  register: helm_reg 
  failed_when: helm_reg.rc > 1
  changed_when: false
    
- name: Get latest kubectl version
  uri:
    url: https://dl.k8s.io/release/stable.txt
    return_content: yes
  register: version

- name: Download the latest kubectl release
  uri:
    url: https://dl.k8s.io/release/{{ version.content }}/bin/linux/amd64/kubectl
    dest: /usr/bin/kubectl
    status_code: 200, 304
  register: kubectl

- name: Kubectl File Permissions
  file:
    path: /usr/bin/kubectl
    mode: "0755"

- name: Check if kubectl is installed
  shell: kubectl version --client
  register: client
  failed_when: client.rc > 1
  changed_when: false

- name: Download K3s
  ansible.builtin.get_url:
    url: https://get.k3s.io
    dest: /tmp/install_k3s.sh
    mode: '0755'

- name: Install K3s
  ansible.builtin.command: /tmp/install_k3s.sh
  changed_when: false

- name: Create KUBECONFIG directory
  ansible.builtin.command: mkdir -p /home/homeserver/.kube
  changed_when: false

- name: Copy KUBECONFIG file to Homeserver user
  ansible.builtin.copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /home/homeserver/.kube/config
    owner: homeserver
    mode: '0600'

- name: Wait for Cluster to Start
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: 8080
    delay: 10
    sleep: 1
